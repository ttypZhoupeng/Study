<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="css/style.css">
    
</head>
<body>
    
    <section class="same_width clear_float">
        <input type="text" id="str">
        <input type="button" value="搜索" id="btn">
        <ul id="goodsUl">
            
        </ul>
        <button id="cart">加入购物车</button>
    </section>


    <script src="js/jquery-1.12.3.min.js"></script>
    <script>


        $(function(){

            var str = location.search.substr(0);
            console.log(decodeURI(str));
            var goods = str.split("?");
            var goodsName = goods[1].substr(11);
            var goodsId = goods[2].substr(9);

            console.log(decodeURI(goodsName));
            console.log(decodeURI(goodsId));

            $.ajax({
                "url":"http://h6.duchengjiu.top/shop/api_goods.php",
                "type":"GET",
                "dataType":"json",
                "data":{
                    "search_text":goodsName
                },
                "success":function(response){
                    console.log(response);
                    $("#goodsUl").html('<li><img src="' +response.data[0].goods_thumb+ '" /><p>' +response.data[0].goods_name+ '</p><p>' +response.data[0].goods_desc+ '</p><p class="price">' +response.data[0].price+ '</p></li>');
                    
                }
            });




            $("#btn").click(function(){
                var strNew = $("#str").val();
                console.log(strNew);


                $.ajax({
                    "url": "http://h6.duchengjiu.top/shop/api_goods.php",
                    "type":"GET",
                    "data":{
                        "search_text":strNew
                    },
                    "dataType":"json",
                    "success":function(response){
                        var obj = response;
                        console.log(obj);
                        $("#goodsUl").html("");
                        $("#goodsUl").append('<li><img src="' +obj.data[0].goods_thumb+ '" /><p>' +obj.data[0].goods_name+ '</p><p>' +obj.data[0].goods_desc+ '</p><p class="price">' +obj.data[0].price+ '</p></li>');
                    }
                })
            });



            $("#cart").click(function(){


                if(!localStorage.getItem("token")){
                    alert("请登录后才能使用购物车功能！");

                    location.href = "login.html#callback="+location.href;
                    return;
                }

                console.log(decodeURI(goodsId));

                var goods_number = localStorage.getItem("cart"+decodeURI(goodsId));

                goods_number = goods_number?parseInt(goods_number)+1:1;
                $.ajax({
                    "url":"http://h6.duchengjiu.top/shop/api_cart.php?token="+localStorage.getItem("token"),
                    "type":"POST",
                    "dataType":"json",
                    "data":{
                        "goods_id":goodsId,
                        "number":goods_number
                    },
                    "success":function(response){
                        localStorage.setItem("cart"+goodsId,goods_number);
                        location.href="cart.html";
                        console.log(response);
                    }
                })
            })


        })
        
    </script>
</body>
</html>